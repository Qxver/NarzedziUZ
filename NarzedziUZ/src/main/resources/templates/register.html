<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/register.css}">
    <title>Register</title>

    <!-- Add Cap widget script to <head> -->
    <script src="https://cdn.jsdelivr.net/npm/@cap.js/widget@0.1.32"></script>
</head>

<body>

<div th:insert="~{fragments/navbar :: navbar}"></div>

<div class="content">
    <div class="register">
        <h1>Create new account</h1>

        <div th:if="${error}" style="color: red; margin-bottom: 15px;">
            <p th:text="${error}"></p>
        </div>

        <form th:action="@{/register}" method="post" id="registerForm" onsubmit="return validateForm()">
            <input type="text" id="firstName" name="firstName" placeholder="First name" required>
            <span class="error-message" id="firstNameError">First name is required</span>

            <input type="text" id="lastName" name="lastName" placeholder="Last name" required>
            <span class="error-message" id="lastNameError">Last name is required</span>

            <input type="email" id="email" name="email" placeholder="E-mail" required>
            <span class="error-message" id="emailError">Please enter a valid email address</span>

            <input type="password" id="password" name="password" placeholder="Password" required>
            <div class="password-requirements">
                <div class="requirement" id="lengthReq">✗ At least 8 characters</div>
                <div class="requirement" id="uppercaseReq">✗ At least 1 uppercase letter</div>
                <div class="requirement" id="numberReq">✗ At least 1 number</div>
                <div class="requirement" id="specialReq">✗ At least 1 special character</div>
            </div>
            <span class="error-message" id="passwordError">Password does not meet requirements</span>

            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm password" required>
            <span class="error-message" id="confirmPasswordError">Passwords do not match</span>

            <!-- Captcha Section -->
            <div class="captcha-container">
                <cap-widget
                  data-cap-api-endpoint="http://localhost:8000/d2acb75376/"
                  id="captcha-widget"
                ></cap-widget>
                <input type="hidden" id="captchaToken" name="captchaToken">
            </div>

            <button type="submit">Register</button>
        </form>

        <a href="/login">Already have an account? Login</a>
    </div>
</div>

<script>
    const emailPattern = /^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
    const passwordPattern = /^(?=.*[0-9])(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;

    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;

        const lengthReq = document.getElementById('lengthReq');
        if (password.length >= 8) {
            lengthReq.classList.remove('invalid');
            lengthReq.classList.add('valid');
            lengthReq.textContent = '✓ At least 8 characters';
        } else {
            lengthReq.classList.remove('valid');
            lengthReq.classList.add('invalid');
            lengthReq.textContent = '✗ At least 8 characters';
        }

        const uppercaseReq = document.getElementById('uppercaseReq');
        if (/[A-Z]/.test(password)) {
            uppercaseReq.classList.remove('invalid');
            uppercaseReq.classList.add('valid');
            uppercaseReq.textContent = '✓ At least 1 uppercase letter';
        } else {
            uppercaseReq.classList.remove('valid');
            uppercaseReq.classList.add('invalid');
            uppercaseReq.textContent = '✗ At least 1 uppercase letter';
        }

        const numberReq = document.getElementById('numberReq');
        if (/[0-9]/.test(password)) {
            numberReq.classList.remove('invalid');
            numberReq.classList.add('valid');
            numberReq.textContent = '✓ At least 1 number';
        } else {
            numberReq.classList.remove('valid');
            numberReq.classList.add('invalid');
            numberReq.textContent = '✗ At least 1 number';
        }

        const specialReq = document.getElementById('specialReq');
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            specialReq.classList.remove('invalid');
            specialReq.classList.add('valid');
            specialReq.textContent = '✓ At least 1 special character';
        } else {
            specialReq.classList.remove('valid');
            specialReq.classList.add('invalid');
            specialReq.textContent = '✗ At least 1 special character';
        }
    });

    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        const errorSpan = document.getElementById('confirmPasswordError');

        if (confirmPassword && password !== confirmPassword) {
            this.classList.add('invalid');
            errorSpan.classList.add('show');
        } else {
            this.classList.remove('invalid');
            errorSpan.classList.remove('show');
        }
    });

    function validateForm() {
        let isValid = true;

        const firstName = document.getElementById('firstName');
        const firstNameError = document.getElementById('firstNameError');
        if (firstName.value.trim() === '') {
            firstName.classList.add('invalid');
            firstNameError.classList.add('show');
            isValid = false;
        } else {
            firstName.classList.remove('invalid');
            firstNameError.classList.remove('show');
        }

        const lastName = document.getElementById('lastName');
        const lastNameError = document.getElementById('lastNameError');
        if (lastName.value.trim() === '') {
            lastName.classList.add('invalid');
            lastNameError.classList.add('show');
            isValid = false;
        } else {
            lastName.classList.remove('invalid');
            lastNameError.classList.remove('show');
        }

        const email = document.getElementById('email');
        const emailError = document.getElementById('emailError');
        if (!emailPattern.test(email.value)) {
            email.classList.add('invalid');
            emailError.classList.add('show');
            isValid = false;
        } else {
            email.classList.remove('invalid');
            emailError.classList.remove('show');
        }

        const password = document.getElementById('password');
        const passwordError = document.getElementById('passwordError');
        if (!passwordPattern.test(password.value)) {
            password.classList.add('invalid');
            passwordError.classList.add('show');
            isValid = false;
        } else {
            password.classList.remove('invalid');
            passwordError.classList.remove('show');
        }

        const confirmPassword = document.getElementById('confirmPassword');
        const confirmPasswordError = document.getElementById('confirmPasswordError');
        if (password.value !== confirmPassword.value) {
            confirmPassword.classList.add('invalid');
            confirmPasswordError.classList.add('show');
            isValid = false;
        } else {
            confirmPassword.classList.remove('invalid');
            confirmPasswordError.classList.remove('show');
        }

        return isValid;
    }

    let captchaToken = null;

    // Wait for the widget to be ready
    window.addEventListener('DOMContentLoaded', function() {
        const captchaWidget = document.getElementById('captcha-widget');
        console.log('Widget element:', captchaWidget);

        // Listen for the solve event from the captcha widget
        captchaWidget.addEventListener('solve', function(e) {
            console.log('CAPTCHA solved! Event:', e);
            console.log('Token:', e.detail.token);
            captchaToken = e.detail.token;
            document.getElementById('captchaToken').value = captchaToken;
        });

        // Also listen for other possible events
        captchaWidget.addEventListener('error', function(e) {
            console.error('CAPTCHA error:', e);
        });

        captchaWidget.addEventListener('load', function(e) {
            console.log('CAPTCHA widget loaded:', e);
        });
    });

    // Captcha is optional - form submits with standard validation only
</script>

</body>
</html>
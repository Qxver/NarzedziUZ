<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <link rel="stylesheet" th:href="@{/css/purchase_form.css}">
    <script th:src="@{/js/theme.js}"></script>
    <title>Twój Koszyk - NarzedziUZ</title>
</head>
<body>

<div th:insert="~{fragments/navbar :: navbar}"></div>

<div class="home-container">

    <div class="products-grid">
        <div class="product-card" th:each="item : ${cartItems}">

            <div class="product-image-container">
                <a th:href="@{/product/{id}(id=${item.product.productId})}" class="product-link">
                    <div class="product-image">
                        <img th:if="${item.product.photo != null and !item.product.photo.isEmpty()}"
                             th:src="@{${item.product.photo}}"
                             th:alt="${item.product.name}">
                        <div th:if="${item.product.photo == null or item.product.photo.isEmpty()}" class="no-image">No Image</div>
                    </div>
                </a>
            </div>

            <div class="product-details">
                <a th:href="@{/product/{id}(id=${item.product.productId})}" class="product-title-link">
                    <h3 th:text="${item.product.name}">Product Name</h3>
                </a>

                <p class="product-manufacturer" th:text="${item.product.manufacturer}">Manufacturer</p>
                <p class="product-quantity">
                    Quantity: <span th:text="${item.quantity}">1</span>
                </p>

                <div class="price-and-remove">
                    <p class="product-total-price">
                        Total: <span th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 2, 'POINT')} + ' PLN'">0.00 PLN</span>
                    </p>

                    <form th:action="@{/cart/remove/{cartItemId}(cartItemId=${item.cartItemId})}" method="post">
                        <input type="hidden" name="_method" value="delete" />
                        <button type="submit" class="remove-button">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${#lists.isEmpty(cartItems)}" class="no-products">
        <p>Your cart is empty.</p>
        <p><a th:href="@{/}">Return to the homepage to start shopping.</a></p>
    </div>

    <div th:if="${not #lists.isEmpty(cartItems)}" class="cart-summary">
        <div th:with="totalAmount=${#aggregates.sum(cartItems.![product.price * quantity])}">
            <h3>Grand Total: <span th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 2, 'POINT')} + ' PLN'">0.00 PLN</span></h3>
        </div>

        <button class="checkout-button">Proceed to Checkout</button>
    </div>
    <div class="form-popup" id="myForm">
        <form action="/process-shipping" method="post" class="form-container" novalidate>
            <h2>Checkout</h2>

            <details name="checkout-step" open>
                <summary>Shipping Address</summary>

                <div style="padding: 10px 0;">
                    <label><b>Email</b></label>
                    <input type="email" placeholder="john.doe@example.com" name="email" required>

                    <label for="country-select"><b>Country</b></label>
                    <select name="country" id="country-select">
                        <option value="AF">Afganistan</option>
                        <option value="AL">Albania</option>
                        <option value="DZ">Algieria</option>
                        <option value="AD">Andora</option>
                        <option value="AO">Angola</option>
                        <option value="SA">Arabia Saudyjska</option>
                        <option value="AR">Argentyna</option>
                        <option value="AM">Armenia</option>
                        <option value="AU">Australia</option>
                        <option value="AT">Austria</option>
                        <option value="AZ">Azerbejdżan</option>
                        <option value="BS">Bahamy</option>
                        <option value="BH">Bahrajn</option>
                        <option value="BD">Bangladesz</option>
                        <option value="BB">Barbados</option>
                        <option value="BE">Belgia</option>
                        <option value="BZ">Belize</option>
                        <option value="BJ">Benin</option>
                        <option value="BT">Bhutan</option>
                        <option value="BY">Białoruś</option>
                        <option value="BO">Boliwia</option>
                        <option value="BA">Bośnia i Hercegowina</option>
                        <option value="BW">Botswana</option>
                        <option value="BR">Brazylia</option>
                        <option value="BN">Brunei</option>
                        <option value="BG">Bułgaria</option>
                        <option value="BF">Burkina Faso</option>
                        <option value="BI">Burundi</option>
                        <option value="CL">Chile</option>
                        <option value="CN">Chiny</option>
                        <option value="HR">Chorwacja</option>
                        <option value="CY">Cypr</option>
                        <option value="TD">Czad</option>
                        <option value="ME">Czarnogóra</option>
                        <option value="CZ">Czechy</option>
                        <option value="DK">Dania</option>
                        <option value="CD">Demokratyczna Republika Konga</option>
                        <option value="DM">Dominika</option>
                        <option value="DO">Dominikana</option>
                        <option value="DJ">Dżibuti</option>
                        <option value="EG">Egipt</option>
                        <option value="EC">Ekwador</option>
                        <option value="ER">Erytrea</option>
                        <option value="EE">Estonia</option>
                        <option value="SZ">Eswatini</option>
                        <option value="ET">Etiopia</option>
                        <option value="FJ">Fidżi</option>
                        <option value="PH">Filipiny</option>
                        <option value=\"FI\">Finlandia</option>
                        <option value="FR">Francja</option>
                        <option value="GA">Gabon</option>
                        <option value="GM">Gambia</option>
                        <option value="GH">Ghana</option>
                        <option value="GR">Grecja</option>
                        <option value="GD">Grenada</option>
                        <option value="GE">Gruzja</option>
                        <option value="GY">Gujana</option>
                        <option value="GT">Gwatemala</option>
                        <option value="GN">Gwinea</option>
                        <option value="GW">Gwinea Bissau</option>
                        <option value="GQ">Gwinea Równikowa</option>
                        <option value="HT">Haiti</option>
                        <option value="ES">Hiszpania</option>
                        <option value="NL">Holandia</option>
                        <option value="HN">Honduras</option>
                        <option value="IN">Indie</option>
                        <option value="ID">Indonezja</option>
                        <option value="IQ">Irak</option>
                        <option value="IR">Iran</option>
                        <option value="IE">Irlandia</option>
                        <option value="IS">Islandia</option>
                        <option value="IL">Izrael</option>
                        <option value="JM">Jamajka</option>
                        <option value="JP">Japonia</option>
                        <option value="YE">Jemen</option>
                        <option value="JO">Jordania</option>
                        <option value="KH">Kambodża</option>
                        <option value="CM">Kamerun</option>
                        <option value="CA">Kanada</option>
                        <option value="QA">Katar</option>
                        <option value="KZ">Kazachstan</option>
                        <option value="KE">Kenia</option>
                        <option value="KG">Kirgistan</option>
                        <option value="KI">Kiribati</option>
                        <option value="CO">Kolumbia</option>
                        <option value="KM">Komory</option>
                        <option value="CG">Kongo</option>
                        <option value="KR">Korea Południowa</option>
                        <option value="KP">Korea Północna</option>
                        <option value="CR">Kostaryka</option>
                        <option value="CU">Kuba</option>
                        <option value="KW">Kuwejt</option>
                        <option value="LA">Laos</option>
                        <option value="LS">Lesotho</option>
                        <option value="LB">Liban</option>
                        <option value="LR">Liberia</option>
                        <option value="LY">Libia</option>
                        <option value="LI">Liechtenstein</option>
                        <option value="LT">Litwa</option>
                        <option value="LU">Luksemburg</option>
                        <option value="MK">Macedonia Północna</option>
                        <option value="MG">Madagaskar</option>
                        <option value="MW">Malawi</option>
                        <option value="MV">Malediwy</option>
                        <option value="MY">Malezja</option>
                        <option value="ML">Mali</option>
                        <option value="MT">Malta</option>
                        <option value="MA">Maroko</option>
                        <option value="MR">Mauretania</option>
                        <option value="MU">Mauritius</option>
                        <option value="MX">Meksyk</option>
                        <option value="FM">Mikronezja</option>
                        <option value="MM">Mjanma</option>
                        <option value="MD">Mołdawia</option>
                        <option value="MC">Monako</option>
                        <option value="MN">Mongolia</option>
                        <option value="MZ">Mozambik</option>
                        <option value="NA">Namibia</option>
                        <option value="NR">Nauru</option>
                        <option value="NP">Nepal</option>
                        <option value="DE">Niemcy</option>
                        <option value="NE">Niger</option>
                        <option value="NG">Nigeria</option>
                        <option value="NI">Nikaragua</option>
                        <option value="NO">Norwegia</option>
                        <option value="NZ">Nowa Zelandia</option>
                        <option value="OM">Oman</option>
                        <option value="PK">Pakistan</option>\n    <option value="PW">Palau</option>
                        <option value="PA">Panama</option>
                        <option value="PG">Papua-Nowa Gwinea</option>
                        <option value="PY">Paragwaj</option>
                        <option value="PE">Peru</option>
                        <option value="PL" selected>Polska</option>
                        <option value="PT">Portugalia</option>
                        <option value="ZA">Republika Południowej Afryki</option>
                        <option value="CF">Republika Środkowoafrykańska</option>
                        <option value="CV">Republika Zielonego Przylądka</option>
                        <option value="RU">Rosja</option>
                        <option value="RO">Rumunia</option>
                        <option value="RW">Rwanda</option>
                        <option value="KN">Saint Kitts i Nevis</option>
                        <option value="LC">Saint Lucia</option>
                        <option value="VC">Saint Vincent i Grenadyny</option>
                        <option value="SV">Salwador</option>
                        <option value="WS">Samoa</option>
                        <option value="SM">San Marino</option>
                        <option value="SN">Senegal</option>
                        <option value="RS">Serbia</option>
                        <option value="SC">Seszele</option>
                        <option value=\"SL\">Sierra Leone</option>
                        <option value="SG">Singapur</option>
                        <option value="SK">Słowacja</option>
                        <option value="SI">Słowenia</option>
                        <option value="SO">Somalia</option>
                        <option value="LK">Sri Lanka</option>
                        <option value="US">Stany Zjednoczone</option>
                        <option value="SD">Sudan</option>
                        <option value="SS">Sudan Południowy</option>
                        <option value="SR">Surinam</option>
                        <option value="SY">Syria</option>
                        <option value="CH">Szwajcaria</option>
                        <option value="SE">Szwecja</option>
                        <option value="TJ">Tadżykistan</option>
                        <option value="TH">Tajlandia</option>
                        <option value="TZ">Tanzania</option>
                        <option value="TL">Timor Wschodni</option>
                        <option value="TG">Togo</option>
                        <option value="TO">Tonga</option>
                        <option value="TT">Trynidad i Tobago</option>
                        <option value="TN">Tunezja</option>
                        <option value="TR">Turcja</option>
                        <option value="TM">Turkmenistan</option>
                        <option value="TV">Tuvalu</option>
                        <option value="UG">Uganda</option>
                        <option value="UA">Ukraina</option>
                        <option value="UY">Urugwaj</option>
                        <option value="UZ">Uzbekistan</option>
                        <option value="VU">Vanuatu</option>
                        <option value="VA">Watykan</option>
                        <option value="VE">Wenezuela</option>
                        <option value="GB">Wielka Brytania</option>
                        <option value="VN">Wietnam</option>
                        <option value="IT">Włochy</option>
                        <option value="CI">Wybrzeże Kości Słoniowej</option>
                        <option value="SB">Wyspy Salomona</option>
                        <option value="ST">Wyspy Świętego Tomasza i Książęca</option>
                        <option value="HU">Węgry</option>
                        <option value="ZM">Zambia</option>
                        <option value="ZW">Zimbabwe</option>
                        <option value="AE">Zjednoczone Emiraty Arabskie</option>
                        <option value="LV">Łotwa</option>
                    </select>

                    <label><b>City</b></label>
                    <input type="text" placeholder="London" name="city" required>

                    <label><b>Postal Code</b></label>
                    <input type="text" placeholder="SW1A 1AA" name="zipCode" required>

                    <label><b>Street Address</b></label>
                    <input type="text" placeholder="Baker Street" name="street" required>
    <div th:if="${not #lists.isEmpty(cartItems)}"
         class="cart-summary"
         th:with="
            totalAmount=${#aggregates.sum(cartItems.![product.price * quantity])},
            discountPercent=${discount != null ? discount.percent : 0},
            finalAmount=${totalAmount * (100 - discountPercent) / 100}
         ">

        <p th:if="${successMessage}" style="color:green" th:text="${successMessage}"></p>
        <p th:if="${errorMessage}" style="color:red" th:text="${errorMessage}"></p>

        <form th:action="@{/cart/apply-discount}" method="post" class="discount-form">
            <input type="text" name="code" placeholder="Kod rabatowy">
            <button type="submit">Zastosuj</button>
        </form>

        <p th:if="${discount != null}">
            Zastosowany kod:
            <b th:text="${discount.code}"></b>
            (-<span th:text="${discount.percent}"></span>%)
        </p>

        <h3>
            Suma przed rabatem:
            <span th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 2, 'POINT')}"></span> PLN
        </h3>

        <h3 th:if="${discount != null}">
            Do zapłaty:
            <span th:text="${#numbers.formatDecimal(finalAmount, 0, 'COMMA', 2, 'POINT')}"></span> PLN
        </h3>

        <button class="checkout-button" onclick="openForm()">Przejdź do Kasy</button>
    </div>

    <div class="form-popup" id="myForm">
        <form action="/process-shipping" method="post" class="form-container" novalidate>
            <h2>Checkout</h2>

        </form>
    </div>

    <script>
        function openForm() {
            document.getElementById("myForm").style.display = "block";
        }
        function closeForm() {
            document.getElementById("myForm").style.display = "none";
        }
    </script>

</div>
</body>
</html>
